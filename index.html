<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Your Fashion — Стил и качество</title>
<meta name="description" content="Онлайн бутик за мъжка и дамска мода. Стил, качество и бърза доставка." />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<meta name="theme-color" content="#111" />
<style>
:root{
  --bg:#ffffff; --fg:#0f172a; --muted:#f6f7fb; --line:#e5e7eb;
  --dark:#0b0b0b; --brand:#111; --shadow:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
img{max-width:100%;display:block}
a{color:inherit;text-decoration:none}
button{font:inherit}
.container{max-width:1200px;margin:0 auto;padding:0 20px}

/* ===== HEADER ===== */
.topbar{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--line)}
.topbar__inner{height:72px;display:flex;align-items:center;justify-content:space-between;gap:16px}
.brand{display:flex;align-items:center;gap:10px}
.brand__logo{height:30px}
.brand__name{font-family:"Playfair Display",serif;font-weight:700;letter-spacing:.06em}

.nav{display:flex;gap:18px;align-items:center}
.nav__btn{background:none;border:0;padding:8px 6px;font-weight:500;cursor:pointer}
.has-dd{position:relative}
.dd{position:absolute;top:120%;left:0;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;padding:10px;display:none;min-width:220px}
.dd__link{display:block;padding:10px;border-radius:8px}
.dd__link:hover{background:var(--muted)}
.has-dd:hover .dd{display:block}

/* ===== ACTIONS ===== */
.actions{display:flex;align-items:center;gap:8px}
.icon-btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px;cursor:pointer}
.icon-btn:hover{box-shadow:var(--shadow)}
.badge{position:absolute;top:-6px;right:-6px;background:#000;color:#fff;border-radius:999px;padding:1px 6px;font-size:12px}
.action-tab{font-weight:600;cursor:pointer;padding:8px 14px;border-radius:12px;border:1px solid var(--line);background:#fff}
.action-tab:hover{box-shadow:var(--shadow)}
.hamburger{display:none;background:none;border:1px solid var(--line);border-radius:12px;padding:8px}
.hamburger span{display:block;width:18px;height:2px;background:#111;margin:3px 0}

/* ===== USER DROPDOWN ===== */
.user-menu{position:relative;margin-right:10px}
.user-btn{
  display:flex;align-items:center;gap:6px;
  background:none;border:0;font-weight:600;cursor:pointer;
  padding:8px 10px;border-radius:8px;
}
.user-btn:hover{background:#f2f2f2}
.user-dd{
  position:absolute;top:120%;right:0;display:none;flex-direction:column;
  background:#fff;border:1px solid var(--line);border-radius:10px;
  box-shadow:var(--shadow);min-width:180px;z-index:200;overflow:hidden
}
.user-dd a{
  padding:10px 14px;color:#111;text-decoration:none;font-size:14px
}
.user-dd a:hover{background:var(--muted)}
.user-menu.open .user-dd{display:flex}

/* ===== MOBILE DRAWER ===== */
.drawer{position:fixed;inset:0 0 0 auto;max-width:360px;transform:translateX(100%);transition:.28s;z-index:70;background:#fff;border-left:1px solid var(--line);padding:18px}
.drawer.open{transform:translateX(0)}
.drawer__top{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.drawer__nav details{border-bottom:1px dashed var(--line);padding:10px 0}
.drawer__nav summary{font-weight:600;cursor:pointer;list-style:none}
.drawer__nav a{display:block;padding:8px 0}

/* ===== SEARCH ===== */
.search{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:65;align-items:center;justify-content:center}
.search.show{display:flex}
.search__box{background:#fff;padding:16px;border-radius:14px;display:flex;gap:8px;align-items:center;min-width:min(720px,92vw);box-shadow:var(--shadow)}
.search__box input{flex:1;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:16px}
.search__close{border:0;background:#111;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}

/* ===== HERO ===== */
.hero{position:relative;height:62vh;min-height:420px;overflow:hidden}
.hero__bg{width:100%;height:100%;object-fit:cover;filter:grayscale(20%)}
.hero__overlay{position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.35))}
.hero__content{position:absolute;inset:0;display:grid;place-items:center;text-align:center;color:#fff}
.hero h1{font-family:"Playfair Display",serif;font-weight:700;letter-spacing:.05em;font-size:clamp(28px,5vw,54px);margin:0 0 12px}
.btn{border:1px solid #111;background:#111;color:#fff;border-radius:999px;padding:12px 20px;font-weight:600;cursor:pointer}
.btn--light{background:#fff;color:#111;border-color:#fff}
.btn--full{width:100%}

/* ===== CATEGORIES ===== */
.cats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:40px auto}
.cat{position:relative;border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
.cat img{aspect-ratio: 4/3;object-fit:cover;filter:grayscale(10%)}
.cat__label{position:absolute;inset:auto 0 0 0;padding:14px 16px;background:linear-gradient(to top,rgba(0,0,0,.6),rgba(0,0,0,0));color:#fff}
.cat__label h3{margin:0 0 6px 0;font-family:"Playfair Display",serif}
.link{font-weight:600;border-bottom:1px solid currentColor}

/* ===== PRODUCTS ===== */
.section-head{display:flex;align-items:center;justify-content:space-between;margin:40px 0 16px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
.card{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff;transition:.2s}
.card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.card__img{aspect-ratio: 4/5;object-fit:cover;background:#f2f2f2}
.card__body{padding:12px}
.card__title{font-weight:600;margin:2px 0 6px}
.card__price{font-weight:700}
.card__row{display:flex;align-items:center;justify-content:space-between;gap:8px}

/* ===== ABOUT ===== */
.about{background:var(--muted);margin:60px 0 0}
.about__inner{display:flex;align-items:flex-start;justify-content:space-between;padding:40px 0;gap:40px}
.bullets{list-style:none;margin:0;padding:0;display:grid;gap:6px}
.bullets li{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px}

/* ===== FOOTER ===== */
.footer{background:#111;color:#eee;margin-top:40px}
.footer__inner{display:grid;grid-template-columns:2fr 1fr 1fr;gap:20px;padding:34px 0}
.footer a{display:block;color:#ddd;margin:6px 0}
.newsletter{display:flex;gap:8px}
.newsletter input{flex:1;border-radius:12px;border:0;padding:10px 12px}
.copy{text-align:center;color:#bbb;padding:10px;border-top:1px solid #222}

/* ===== CART ===== */
.cart{position:fixed;inset:0 0 0 auto;transform:translateX(100%);transition:.28s;z-index:75;background:#fff;max-width:420px;border-left:1px solid var(--line);display:flex;flex-direction:column}
.cart.open{transform:translateX(0)}
.cart__head{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--line)}
.cart__items{flex:1;overflow:auto;padding:12px}
.cart__item{display:grid;grid-template-columns:64px 1fr auto;gap:12px;border-bottom:1px solid var(--line);padding:10px 0}
.cart__item img{width:64px;height:80px;object-fit:cover;border-radius:8px}
.cart__foot{border-top:1px solid var(--line);padding:14px;display:grid;gap:10px}
.cart__line{display:flex;align-items:center;justify-content:space-between}

/* ===== OVERLAYS ===== */
.site-wrap{transition:filter .25s ease, opacity .25s ease}
.site-wrap.blurred{filter:blur(4px); opacity:.8;} /* ~20% дим + blur */
.overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.2);z-index:100}
.overlay.show{display:grid}
.overlay__panel{position:relative;width:min(520px,92vw);height:500px;border:0;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;background:#fff}
.overlay__close{position:absolute;top:8px;right:8px;border:0;background:#111;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;z-index:5}

/* ===== BACKDROP ===== */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:60}
.backdrop.show{display:block}

/* ===== RESPONSIVE ===== */
@media (max-width:1024px){ .grid{grid-template-columns:repeat(3,1fr)} .cats{grid-template-columns:repeat(3,1fr)} }
@media (max-width:768px){
  .nav{display:none}
  .hamburger{display:inline-flex}
  .grid{grid-template-columns:repeat(2,1fr)}
  .cats{grid-template-columns:1fr 1fr}
  .about__inner{flex-direction:column}
  .footer__inner{grid-template-columns:1р 1fr}
  .topbar__inner{height:64px}
  .hero{height:56vh;min-height:360px}
}
@media (max-width:480px){
  .grid{grid-template-columns:1fr}
  .cats{grid-template-columns:1fr}
  .hero{height:48vh;min-height:300px}
}
</style>
</head>
<body>
<div class="site-wrap" id="siteWrap">
  <header class="topbar" role="banner">
    <div class="container topbar__inner">
      <a class="brand" href="/" aria-label="Your Fashion - начало">
        <svg class="brand__logo" viewBox="0 0 64 64" aria-hidden="true"><path d="M20 22l12-8 12 8-4 10H24l-4-10zM18 34h28l-4 18H22l-4-18z" fill="#111"/></svg>
        <div class="brand__name">Your Fashion</div>
      </a>

      <nav class="nav" aria-label="Основна навигация">
        <div class="nav__item has-dd">
          <button class="nav__btn" aria-haspopup="true" aria-expanded="false">Мъжко</button>
          <div class="dd" role="menu">
            <a href="#" class="dd__link" role="menuitem">Якета</a>
            <a href="#" class="dd__link" role="menuitem">Блузи</a>
            <a href="#" class="dd__link" role="menuitem">Дънки</a>
            <a href="#" class="dd__link" role="menuitem">Аксесоари</a>
          </div>
        </div>
        <div class="nav__item has-dd">
          <button class="nav__btn" aria-haspopup="true" aria-expanded="false">Дамско</button>
          <div class="dd" role="menu">
            <a href="#" class="dd__link" role="menuitem">Палта</a>
            <a href="#" class="dd__link" role="menuitem">Рокли</a>
            <a href="#" class="dd__link" role="menuitem">Панталони</a>
            <a href="#" class="dd__link" role="menuitem">Обувки</a>
          </div>
        </div>
        <a href="#about" class="nav__btn">За нас</a>
      </nav>

      <div class="actions">
        <!-- USER DROPDOWN (вляво от лупата) -->
        <div class="user-menu" id="userMenu">
          <button id="userNameDisplay" class="user-btn" aria-haspopup="true" aria-expanded="false">👤 Гост</button>
          <div class="user-dd" id="userDropdown" role="menu">
            <a href="#" id="ordersLink" role="menuitem">Моите поръчки</a>
            <a href="#" id="historyLink" role="menuitem">История на търсене</a>
            <a href="#" id="logoutBtn" role="menuitem">Изход</a>
          </div>
        </div>

        <button class="icon-btn" id="searchOpen" aria-label="Търсене" type="button">🔍</button>
        <button class="icon-btn" id="cartOpen" aria-label="Кошница" type="button">🛒<span class="badge" id="cartCount">0</span></button>
        <a href="#" class="action-tab" id="loginTab">Login</a>
        <a href="#" class="action-tab" id="adminTab">Admin</a>
        <button class="hamburger" id="hamburger" aria-label="Меню" type="button"><span></span><span></span><span></span></button>
      </div>
    </div>
  </header>

  <!-- MOBILE DRAWER -->
  <aside class="drawer" id="drawer" aria-hidden="true" aria-label="Мобилно меню">
    <div class="drawer__top">
      <strong>Меню</strong>
      <button id="drawerClose" aria-label="Затвори" type="button">✕</button>
    </div>
    <nav class="drawer__nav">
      <details>
        <summary>Мъжко</summary>
        <a href="#">Якета</a>
        <a href="#">Блузи</a>
        <a href="#">Дънки</a>
        <a href="#">Аксесоари</a>
      </details>
      <details>
        <summary>Дамско</summary>
        <a href="#">Палта</a>
        <a href="#">Рокли</a>
        <a href="#">Панталони</a>
        <a href="#">Обувки</a>
      </details>
      <a href="#about">За нас</a>
    </nav>
  </aside>

  <!-- HERO -->
  <section class="hero" aria-label="Начален банер">
    <img class="hero__bg" src="https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=1600&auto=format&fit=crop" alt="" loading="eager" fetchpriority="high">
    <div class="hero__overlay"></div>
    <div class="hero__content">
      <h1>СТИЛ И КАЧЕСТВО</h1>
      <a href="#products" class="btn btn--light">Пазарувай сега</a>
    </div>
  </section>

  <!-- CATEGORIES -->
  <section class="cats container" aria-label="Категории">
    <div class="cat">
      <img src="https://images.unsplash.com/photo-1516257984-b1b4d707412e?q=80&w=1200&auto=format&fit=crop" alt="Мъжко" loading="lazy">
      <div class="cat__label"><h3>Мъжко</h3><a href="#" class="link">Виж колекция</a></div>
    </div>
    <div class="cat">
      <img src="https://images.unsplash.com/photo-1490481651871-ab68de25d43d?q=80&w=1200&auto=format&fit=crop" alt="Дамско" loading="lazy">
      <div class="cat__label"><h3>Дамско</h3><a href="#" class="link">Виж колекция</a></div>
    </div>
    <div class="cat">
      <img src="https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1200&auto=format&fit=crop" alt="Аксесоари" loading="lazy">
      <div class="cat__label"><h3>Аксесоари</h3><a href="#" class="link">Разгледай</a></div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section id="products" class="container" aria-labelledby="products-title">
    <header class="section-head">
      <h2 id="products-title" style="margin:0">Нови предложения</h2>
      <a href="#" class="link">Виж всички</a>
    </header>
    <div class="grid" id="productGrid"></div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="about" aria-label="За магазина">
    <div class="container about__inner">
      <div>
        <h3>За Your Fashion</h3>
        <p>Подбираме селектирани модели с фокус върху материя, кройка и дълготраен стил. Доставяме бързо и коректно.</p>
      </div>
      <ul class="bullets" aria-label="Предимства">
        <li>✔ Преглед и тест</li>
        <li>✔ 14 дни право на връщане</li>
        <li>✔ Експресна доставка</li>
      </ul>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer" role="contentinfo">
    <div class="container footer__inner">
      <div>
        <h4>Контакти</h4>
        <p>support@yourshop.bg<br>+359 88 123 4567</p>
      </div>
      <div>
        <h4>Информация</h4>
        <a href="#">Доставка</a>
        <a href="#">Връщане</a>
        <a href="#">Политика за поверителност</a>
        <a href="#">Условия</a>
      </div>
      <div>
        <h4>Абонамент</h4>
        <form class="newsletter" onsubmit="event.preventDefault(); alert('Благодарим!');" aria-label="Абонамент за новини">
          <input type="email" placeholder="Твоят email" aria-label="Имейл">
          <button class="btn" type="submit">OK</button>
        </form>
      </div>
    </div>
    <div class="copy">© <span id="year"></span> Your Fashion</div>
  </footer>

  <!-- CART -->
  <aside class="cart" id="cart" aria-label="Кошница" aria-hidden="true">
    <div class="cart__head">
      <h3>Кошница</h3>
      <button id="cartClose" aria-label="Затвори" type="button">✕</button>
    </div>
    <div class="cart__items" id="cartItems"></div>
    <div class="cart__foot">
      <div class="cart__line"><span>Общо:</span><strong id="cartTotal">0.00 лв</strong></div>
      <button class="btn btn--full" id="checkoutBtn" type="button">Поръчай</button>
    </div>
  </aside>
</div><!-- /.site-wrap -->

<!-- SEARCH OVERLAY -->
<div class="search" id="search" aria-hidden="true">
  <div class="search__box" role="dialog" aria-modal="true" aria-label="Търсене">
    <input type="text" id="searchInput" placeholder="Търси продукти..." aria-label="Поле за търсене">
    <button id="searchClose" class="search__close" type="button">✕</button>
  </div>
</div>

<!-- ADMIN OVERLAY -->
<div class="overlay" id="adminOverlay" aria-hidden="true">
  <div class="overlay__panel" role="dialog" aria-modal="true" aria-label="Admin">
    <button class="overlay__close" id="overlayClose" aria-label="Затвори" type="button">✕</button>
    <iframe id="adminFrame" src="" title="Admin" style="width:100%;height:100%;border:0;"></iframe>
  </div>
</div>

<!-- USER LOGIN OVERLAY -->
<div class="overlay" id="userOverlay" aria-hidden="true">
  <div class="overlay__panel" role="dialog" aria-modal="true" aria-label="Login / Регистрация">
    <button class="overlay__close" id="userOverlayClose" aria-label="Затвори" type="button">✕</button>
    <iframe id="userFrame" src="" title="User Login" style="width:100%;height:100%;border:0;"></iframe>
  </div>
</div>

<!-- Backdrop за drawer/cart/search -->
<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<script defer>
/* ===== UTIL ===== */
const $=sel=>document.querySelector(sel), $$=sel=>document.querySelectorAll(sel);
const drawer=$('#drawer'), hamburger=$('#hamburger'), drawerClose=$('#drawerClose');
const search=$('#search'), searchOpen=$('#searchOpen'), searchClose=$('#searchClose'), searchInput=$('#searchInput');
const cart=$('#cart'), cartOpen=$('#cartOpen'), cartClose=$('#cartClose');
const backdrop=$('#backdrop'), cartCount=$('#cartCount'), yearSpan=$('#year');
const productGrid=$('#productGrid'), cartItems=$('#cartItems'), cartTotal=$('#cartTotal');
const adminTab=$('#adminTab'), adminOverlay=$('#adminOverlay'), adminFrame=$('#adminFrame'), overlayClose=$('#overlayClose');
const siteWrap=$('#siteWrap');
const loginTab=$('#loginTab'), userOverlay=$('#userOverlay'), userFrame=$('#userFrame'), userOverlayClose=$('#userOverlayClose');

/* User menu refs */
const userMenu = document.getElementById("userMenu");
const userNameDisplay = document.getElementById("userNameDisplay");
const userDropdown = document.getElementById("userDropdown");
const logoutBtn = document.getElementById("logoutBtn");
const historyLink = document.getElementById("historyLink");
const ordersLink = document.getElementById("ordersLink");

/* Year */
yearSpan.textContent=new Date().getFullYear();

/* ===== DEMO DATA ===== */
const PRODUCTS=[
  {id:1,title:'Костюм Slim Fit',price:189.90,img:'https://images.unsplash.com/photo-1520975693416-35e88b9c5df2?w=600'},
  {id:2,title:'Рокля Satin Midi',price:149.00,img:'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=600'},
  {id:3,title:'Пухено палто Noir',price:219.00,img:'https://images.unsplash.com/photo-1517586979034-b72375e7c4f0?w=600'},
  {id:4,title:'Дънки Tapered',price:109.00,img:'https://images.unsplash.com/photo-1490111718993-d98654ce6cf7?w=600'},
  {id:5,title:'Чанта Classic',price:129.00,img:'https://images.unsplash.com/photo-1584917865442-de89df76afd3?w=600'},
  {id:6,title:'Риза Oxford',price:79.00,img:'https://images.unsplash.com/photo-1520975916090-3105956dac38?w=600'},
  {id:7,title:'Боти Chelsea',price:199.00,img:'https://images.unsplash.com/photo-1514996937319-344454492b37?w=600'},
  {id:8,title:'Суитшърт Minimal',price:69.00,img:'https://images.unsplash.com/photo-1520975853984-59ef49b1b8b8?w=600'},
];
const money=v=>v.toFixed(2)+' лв';

/* ===== USER HELPERS (персистенция по потребител) ===== */
const getUser = ()=> JSON.parse(localStorage.getItem('userProfile')||'null');
const getUserId = ()=> (getUser()?.id || null);
const keyCart = ()=> getUserId() ? `CART_${getUserId()}` : `CART`;
const keySearch = ()=> getUserId() ? `SEARCH_${getUserId()}` : `SEARCH_GUEST`;

/* ===== RENDER PRODUCTS ===== */
function renderProducts(){
  productGrid.innerHTML=PRODUCTS.map(p=>`
    <article class="card">
      <img class="card__img" src="${p.img}" alt="${p.title}" loading="lazy">
      <div class="card__body">
        <div class="card__row">
          <h3 class="card__title">${p.title}</h3>
          <div class="card__price">${money(p.price)}</div>
        </div>
        <button class="btn" data-add="${p.id}" type="button">Добави</button>
      </div>
    </article>
  `).join('');
}
renderProducts();

/* ===== CART STATE (запазва и per-user) ===== */
let CART = JSON.parse(localStorage.getItem(keyCart())||localStorage.getItem('CART')||'[]');
function saveCart(){
  localStorage.setItem('CART', JSON.stringify(CART));             // общо (бекъп)
  localStorage.setItem(keyCart(), JSON.stringify(CART));           // user-специфично
}
function cartBadge(){ cartCount.textContent=CART.reduce((a,i)=>a+i.qty,0); }
function renderCart(){
  if(CART.length===0){
    cartItems.innerHTML='<p>Кошницата е празна.</p>';
    cartTotal.textContent=money(0); cartBadge(); return;
  }
  cartItems.innerHTML=CART.map(i=>`
    <div class="cart__item">
      <img src="${i.img}" alt="${i.title}" loading="lazy">
      <div>
        <div style="font-weight:600">${i.title}</div>
        <div>Количество:
          <button data-dec="${i.id}" type="button" aria-label="Намали">−</button>
          <strong>${i.qty}</strong>
          <button data-inc="${i.id}" type="button" aria-label="Увеличи">+</button>
        </div>
        <button data-del="${i.id}" style="margin-top:6px" type="button">Премахни</button>
      </div>
      <div style="font-weight:700">${money(i.price*i.qty)}</div>
    </div>
  `).join('');
  const total=CART.reduce((a,i)=>a+i.price*i.qty,0);
  cartTotal.textContent=money(total); cartBadge();
}
renderCart();

/* ===== SEARCH HISTORY (per-user) ===== */
function saveSearch(q){
  const k = keySearch();
  let history = JSON.parse(localStorage.getItem(k)||'[]');
  history.push({q, time:Date.now()});
  localStorage.setItem(k, JSON.stringify(history));
}

/* ===== EVENTS (cart & products) ===== */
document.addEventListener('click',e=>{
  const add=e.target.getAttribute('data-add');
  const inc=e.target.getAttribute('data-inc');
  const dec=e.target.getAttribute('data-dec');
  const del=e.target.getAttribute('data-del');
  if(add){
    const p=PRODUCTS.find(x=>x.id==add);
    const it=CART.find(x=>x.id==p.id);
    if(it) it.qty++; else CART.push({...p,qty:1});
    saveCart(); renderCart(); openCart();
  }
  if(inc){ const it=CART.find(x=>x.id==inc); if(it){it.qty++; saveCart(); renderCart();} }
  if(dec){ const it=CART.find(x=>x.id==dec); if(it){it.qty=Math.max(1,it.qty-1); saveCart(); renderCart();} }
  if(del){ CART=CART.filter(x=>x.id!=del); saveCart(); renderCart(); }
});

/* ===== UI HELPERS ===== */
function openDrawer(){drawer.classList.add('open'); backdrop.classList.add('show'); drawer.setAttribute('aria-hidden','false');}
function closeDrawer(){drawer.classList.remove('open'); backdrop.classList.remove('show'); drawer.setAttribute('aria-hidden','true');}
function openSearch(){search.classList.add('show'); search.setAttribute('aria-hidden','false'); setTimeout(()=>searchInput.focus(),50);}
function closeSearch(){search.classList.remove('show'); search.setAttribute('aria-hidden','true');}
function openCart(){cart.classList.add('open'); backdrop.classList.add('show'); cart.setAttribute('aria-hidden','false');}
function closeCart(){cart.classList.remove('open'); backdrop.classList.remove('show'); cart.setAttribute('aria-hidden','true');}

hamburger?.addEventListener('click',openDrawer);
drawerClose?.addEventListener('click',closeDrawer);
backdrop.addEventListener('click',()=>{closeDrawer();closeCart();closeSearch();});
searchOpen?.addEventListener('click',openSearch);
searchClose?.addEventListener('click',closeSearch);
cartOpen.addEventListener('click',openCart);
cartClose.addEventListener('click',closeCart);
document.getElementById('checkoutBtn').addEventListener('click',()=>alert('Демо checkout. Свържи Stripe/PayPal за реални поръчки.'));

/* ===== SEARCH INPUT SAVE ===== */
searchInput?.addEventListener("keydown", e=>{
  if(e.key==="Enter" && searchInput.value.trim()){
    saveSearch(searchInput.value.trim());
    // Тук направи реално търсене...
    closeSearch();
  }
});

/* ===== ADMIN OVERLAY ===== */
function openAdmin(){
  adminFrame.src='admin.html';
  adminOverlay.classList.add('show');
  adminOverlay.setAttribute('aria-hidden','false');
  siteWrap.classList.add('blurred');
}
function closeAdmin(){
  adminOverlay.classList.remove('show');
  adminOverlay.setAttribute('aria-hidden','true');
  siteWrap.classList.remove('blurred');
  adminFrame.src='';
}
document.getElementById('adminTab').addEventListener('click',e=>{e.preventDefault();openAdmin();});
document.getElementById('overlayClose').addEventListener('click',closeAdmin);
adminOverlay.addEventListener('click',e=>{ if(e.target===adminOverlay) closeAdmin(); });
window.addEventListener('message',(e)=>{ if(e.data==='admin:close') closeAdmin(); });

/* ===== USER LOGIN OVERLAY ===== */
function openUserLogin(){
  userFrame.src='userlogin.html';           // пътят до E:\MAGAZIN_SITE\userlogin.html
  userOverlay.classList.add('show');
  userOverlay.setAttribute('aria-hidden','false');
  siteWrap.classList.add('blurred');        // ~20% blur/дим
}
function closeUserLogin(){
  userOverlay.classList.remove('show');
  userOverlay.setAttribute('aria-hidden','true');
  siteWrap.classList.remove('blurred');
  userFrame.src='';                         // освобождава ресурси
}
loginTab.addEventListener('click',(e)=>{ e.preventDefault(); openUserLogin(); });
userOverlayClose.addEventListener('click',closeUserLogin);
userOverlay.addEventListener('click',(e)=>{ if(e.target===userOverlay) closeUserLogin(); });

/* ===== USER DROPDOWN ===== */
userNameDisplay.addEventListener("click",()=>{
  const expanded = userNameDisplay.getAttribute('aria-expanded')==='true';
  userNameDisplay.setAttribute('aria-expanded', String(!expanded));
  userMenu.classList.toggle("open");
});
document.addEventListener("click",(e)=>{
  if(!userMenu.contains(e.target)) { userMenu.classList.remove("open"); userNameDisplay.setAttribute('aria-expanded','false'); }
});

/* ===== USER ACTIONS ===== */
logoutBtn.addEventListener("click",(e)=>{
  e.preventDefault();
  localStorage.removeItem("userProfile");
  localStorage.removeItem("authToken");
  // не трием персистираните кошници/истории; остават по userId
  syncUserState(); // връща Гост
  userMenu.classList.remove("open");
});
historyLink.addEventListener("click",(e)=>{
  e.preventDefault();
  const history = JSON.parse(localStorage.getItem(keySearch())||'[]');
  if(history.length===0) alert("Нямаш запазени търсения.");
  else{
    const txt = history.slice(-20).reverse().map(h=>`• ${h.q}`).join("\n");
    alert("История на търсене (последни 20):\n\n"+txt);
  }
});
ordersLink.addEventListener("click",(e)=>{
  e.preventDefault();
  alert("Тук ще покажеш реалните поръчки от бекенда (TODO).");
});

/* ===== USER SYNC ===== */
function syncUserState(){
  const user = getUser();
  if(user && user.firstName){
    userNameDisplay.textContent = `👤 ${user.firstName}`;
    loginTab.textContent = "Профил";
    // Зареждаме user-специфична кошница, ако има
    const stored = JSON.parse(localStorage.getItem(keyCart())||'[]');
    CART = stored;
    renderCart();
  } else {
    userNameDisplay.textContent = "👤 Гост";
    loginTab.textContent = "Login";
    // Оставяме текущата кошница да стои (гост/последна)
  }
  cartBadge();
}

/* ===== MESSAGE BUS (от userlogin.html) ===== */
window.addEventListener("message",(e)=>{
  if(e.data==="user:registered"){
    syncUserState();
    closeUserLogin();
  }
  if(e.data==="user:close"){
    closeUserLogin();
  }
});

/* ===== INIT ===== */
syncUserState();
cartBadge();

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){ closeDrawer(); closeCart(); closeSearch(); closeAdmin(); closeUserLogin(); }
});
</script>
</body>
</html>
